<div class="seller-dashboard">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Seller Dashboard</h1>
      <p class="page-subtitle">Manage your products</p>
    </div>
    <button
      (click)="showAddForm ? resetForm() : null; showAddForm = !showAddForm"
      class="btn-add-product"
    >
      <svg *ngIf="!showAddForm" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
      <svg *ngIf="showAddForm" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      {{ showAddForm ? 'Cancel' : 'Add New Product' }}
    </button>
  </div>

  <!-- Add Product Form - Two Steps -->
  <div *ngIf="showAddForm" class="add-product-form">
    <!-- Step indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="creationStep === 1" [class.completed]="creationStep === 2">
        <span class="step-number">1</span>
        <span class="step-label">Product Details</span>
      </div>
      <div class="step-line" [class.active]="creationStep === 2"></div>
      <div class="step" [class.active]="creationStep === 2">
        <span class="step-number">2</span>
        <span class="step-label">Add Images</span>
      </div>
    </div>

    <!-- Step 1: Product Details -->
    <div *ngIf="creationStep === 1">
      <h2>Create New Product</h2>
      <form (ngSubmit)="createProduct()">
        <div class="form-group">
          <label for="name">Product Name</label>
          <input
            id="name"
            type="text"
            [(ngModel)]="newProduct.name"
            name="name"
            placeholder="Enter product name"
            required
          />
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            [(ngModel)]="newProduct.description"
            name="description"
            placeholder="Enter product description"
            rows="4"
            required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select
            id="category"
            [(ngModel)]="newProduct.category"
            name="category"
            required
          >
            <option [ngValue]="undefined" disabled>Select a category</option>
            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="price">Price ($)</label>
            <input
              id="price"
              type="number"
              [(ngModel)]="newProduct.price"
              name="price"
              placeholder="0.00"
              min="0"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label for="stock">Stock</label>
            <input
              id="stock"
              type="number"
              [(ngModel)]="newProduct.stock"
              name="stock"
              placeholder="Available quantity"
              min="0"
              required
            />
          </div>
        </div>

        <div *ngIf="formError" class="error-message">{{ formError }}</div>

        <div class="form-actions form-actions-end">
          <button type="submit" class="btn-primary" [disabled]="submitting">
            {{ submitting ? 'Creating...' : 'Next: Add Images' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Step 2: Add Images -->
    <div *ngIf="creationStep === 2">
      <h2>Add Product Images</h2>
      <p class="step-description">
        Add up to {{ maxImagesPerProduct }} images for your product (optional)
      </p>

      <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
      <div *ngIf="formError" class="error-message">{{ formError }}</div>

      <!-- Image preview -->
      <div class="new-product-images" *ngIf="newProductImageEntries.length > 0">
        <div class="image-preview-grid">
          <div class="image-preview-item" *ngFor="let entry of newProductImageEntries; let i = index">
            <div class="preview-placeholder">
              <img [src]="entry.previewUrl" [alt]="entry.file.name" class="preview-img" />
            </div>
            <button class="image-delete-btn" (click)="removeNewProductImage(i)" title="Remove">
              Ã—
            </button>
          </div>
        </div>
        <p class="image-count-info">
          {{ newProductImageEntries.length }}/{{ maxImagesPerProduct }} images selected
        </p>
      </div>

      <!-- File input -->
      <div class="upload-controls" *ngIf="newProductImageEntries.length < maxImagesPerProduct">
        <label class="file-input-label">
          <input
            type="file"
            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
            multiple
            (change)="onNewProductFileSelected($event)"
            [disabled]="submitting"
          />
          <span class="btn-upload">{{
            newProductImageEntries.length === 0 ? 'Choose Images' : 'Add More Images'
          }}</span>
        </label>
      </div>

      <div class="form-actions form-actions-between">
        <button
          type="button"
          class="btn-secondary"
          (click)="skipImageUpload()"
          [disabled]="submitting"
        >
          Skip for Now
        </button>
        <button
          type="button"
          class="btn-primary"
          (click)="uploadNewProductImages()"
          [disabled]="submitting || newProductImageEntries.length === 0"
        >
          {{
            submitting
              ? 'Uploading...'
              : newProductImageEntries.length === 0
              ? 'Finish'
              : 'Upload & Finish'
          }}
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Product Form -->
  <div *ngIf="showEditForm" class="edit-product-form">
    <h2>Edit Product</h2>
    <form (ngSubmit)="updateProduct()">
      <div class="form-group">
        <label for="edit-name">Product Name</label>
        <input
          id="edit-name"
          type="text"
          [(ngModel)]="editProduct.name"
          name="edit-name"
          placeholder="Enter product name"
          required
        />
      </div>

      <div class="form-group">
        <label for="edit-description">Description</label>
        <textarea
          id="edit-description"
          [(ngModel)]="editProduct.description"
          name="edit-description"
          placeholder="Enter product description"
          rows="4"
          required
        ></textarea>
      </div>

      <div class="form-group">
        <label for="edit-category">Category</label>
        <select
          id="edit-category"
          [(ngModel)]="editProduct.category"
          name="edit-category"
          required
        >
          <option [ngValue]="undefined" disabled>Select a category</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="edit-price">Price ($)</label>
          <input
            id="edit-price"
            type="number"
            [(ngModel)]="editProduct.price"
            name="edit-price"
            placeholder="0.00"
            min="0"
            step="0.01"
            required
          />
        </div>

        <div class="form-group">
          <label for="edit-stock">Stock</label>
          <input
            id="edit-stock"
            type="number"
            [(ngModel)]="editProduct.stock"
            name="edit-stock"
            placeholder="Available quantity"
            min="0"
            required
          />
        </div>
      </div>

      <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
      <div *ngIf="formError" class="error-message">{{ formError }}</div>

      <div class="form-actions form-actions-end">
        <button type="button" class="btn-secondary" (click)="cancelEdit()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="submitting">
          {{ submitting ? 'Updating...' : 'Update Product' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Products List -->
  <div *ngIf="loading" class="loading">Loading your products...</div>

  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!showAddForm && !showEditForm" class="products-grid">
    <div *ngFor="let product of myProducts" class="product-card-modern">
      <!-- Featured Image -->
      <div class="product-featured-image">
        <img *ngIf="getProductImages(product.id!).length > 0" 
             [src]="getImageUrl(getProductImages(product.id!)[0])" 
             [alt]="product.name" 
             class="featured-img" />
        <div *ngIf="getProductImages(product.id!).length === 0" class="no-image-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        </div>
        <!-- Image count badge -->
        <div class="image-count-badge" *ngIf="getProductImages(product.id!).length > 1">
          +{{ getProductImages(product.id!).length - 1 }}
        </div>
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <h3 class="product-title">{{ product.name }}</h3>
        <p class="product-description">{{ product.description }}</p>
        <div class="product-meta">
          <span class="product-price">${{ product.price | number:'1.2-2' }}</span>
          <span class="product-stock">Stock: {{ product.stock }}</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="product-actions">
        <button (click)="openEditForm(product)" class="btn-edit-modern">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
          Edit
        </button>
        <button (click)="deleteProduct(product.id!)" class="btn-delete-modern" title="Delete product">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        </button>
      </div>

      <!-- Image Management (expandable) -->
      <details class="image-management">
        <summary class="image-management-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          Manage Images ({{ getProductImages(product.id!).length }}/{{ maxImagesPerProduct }})
        </summary>
        <div class="image-management-content">
          <!-- Image Gallery -->
          <div class="images-gallery" *ngIf="getProductImages(product.id!).length > 0">
            <div class="image-item" *ngFor="let media of getProductImages(product.id!)">
              <img [src]="getImageUrl(media)" [alt]="media.fileName" />
              <button
                class="image-delete-btn"
                (click)="deleteImage(product.id!, media.id!)"
                title="Delete image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Upload Controls -->
          <div *ngIf="canAddMoreImages(product.id!)" class="upload-controls">
            <label class="file-input-label">
              <input
                type="file"
                accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
                multiple
                (change)="onFileSelected($event, product.id!)"
                [disabled]="isUploading(product.id!)"
              />
              <span class="btn-upload">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                Add Images
              </span>
            </label>

            <div *ngIf="getSelectedFiles(product.id!).length > 0" class="selected-files">
              <span>{{ getSelectedFiles(product.id!).length }} file(s) selected</span>
              <button
                class="btn-sm btn-primary"
                (click)="uploadImages(product.id!)"
                [disabled]="isUploading(product.id!)"
              >
                {{ isUploading(product.id!) ? 'Uploading...' : 'Upload' }}
              </button>
              <button class="btn-sm btn-secondary" (click)="clearSelectedFiles(product.id!)">
                Cancel
              </button>
            </div>
          </div>

          <div *ngIf="!canAddMoreImages(product.id!)" class="upload-limit-reached">
            Maximum images reached
          </div>

          <div *ngIf="getImageError(product.id!)" class="image-error">
            {{ getImageError(product.id!) }}
          </div>
        </div>
      </details>
    </div>
  </div>

  <div
    *ngIf="!loading && myProducts.length === 0 && !showAddForm && !showEditForm"
    class="empty-state-modern"
  >
    <div class="empty-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
    </div>
    <h2 class="empty-title">No Products Yet</h2>
    <p class="empty-message">Start building your store by adding your first product.</p>
    <button (click)="showAddForm = true" class="btn-add-product">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
      Add Your First Product
    </button>
  </div>
</div>
